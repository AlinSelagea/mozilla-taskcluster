# Treeherder dependencies...
mysql:
  image: mysql:5.5
  environment:
    MYSQL_ROOT_PASSWORD: treeherder
    MYSQL_DATABASE: treeherder

memcached:
  image: memcached:1.4

mysql:
  image: mysql:5.5
  environment:
    MYSQL_ROOT_PASSWORD: treeherder
    MYSQL_DATABASE: treeherder

kueadmin:
  build: .
  command: |
    /bin/bash -c 'cd /app && ./node_modules/.bin/6to5-node -r /app/src/bin/kue production'
  volumes:
    - .:/app
  ports:
    - "60024:60024"
  links:
    - redis:2.8

# The bootstrap step is special in that it should be run prior to any of the
# "real" processes which need to use the database.
thbootstrap:
  image: lightsofapollo/treeherder
  links:
    - mysql
    - rabbitmq
    - memcached
  command: ./docker/init.sh

thapi:
  image: lightsofapollo/treeherder
  links:
    - mysql
    - rabbitmq
    - memcached
    - thbootstrap
  command: ./docker/gunicorn.sh
  ports:
    - "8000"

test:
  volumes:
    - .:/app
  build: .
  command: /bin/bash
  links:
    - redis
    - rabbitmq
    - thapi
    - thbootstrap

rabbitmq:
  image: rabbitmq:3.4-management
  ports:
    - "15672:15672"
    - "5672:5672"

redis:
  image: redis
  ports:
    - "6379:6379"
